#!/bin/bash

# WARNING: This script is for educational purposes and automates Arch Linux installation.
# It can WIPE YOUR DATA if not configured correctly. Review and edit variables before running.
# Run this in the Arch ISO live environment as root (after booting archlinux.iso).
# Assumes internet connection (use 'iwctl' for WiFi if needed, or ethernet).
# Assumes UEFI system (common modern setup). For BIOS, adjust accordingly.
# Pre-existing /home: Assumes it's on a separate partition and won't be formatted.

# --- CONFIGURE THESE VARIABLES BEFORE RUNNING ---
DISK="/dev/sda"  # Your target disk (e.g., /dev/sda, /dev/nvme0n1). DANGER: This will be partitioned!
BOOT_PARTITION="${DISK}1"  # e.g., /dev/sda1 for /boot (will create 512M EFI)
ROOT_PARTITION="${DISK}2"  # e.g., /dev/sda2 for / (will create remaining space minus home if needed)
HOME_PARTITION="/dev/sda3"  # Your pre-existing /home partition (e.g., /dev/sda3). WILL NOT FORMAT THIS!
SWAP_SIZE="8G"  # Swap size (e.g., "8G" or "none" to skip)
TIMEZONE="America/Los_Angeles"  # Your timezone (e.g., Region/City)
LOCALE="en_US.UTF-8"  # Your locale
HOSTNAME="macarch"  # Your hostname
USERNAME="z3ncoding"  # Your username
USER_PASSWORD="123"  # Your user password (change this!)
ROOT_PASSWORD="123"  # Root password (change this!)
# For Hyprland configs: Assumes you have a USB or git repo with configs. Edit COPY_CONFIGS function.

# Function to handle errors
error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    error_exit "This script must be run as root."
fi

# Update system clock
timedatectl set-ntp true || error_exit "Failed to set NTP."

# Partition the disk (DANGER: This wipes the disk except for specified /home)
if [ "$SWAP_SIZE" != "none" ]; then
    parted -s "$DISK" mklabel gpt \
        mkpart primary fat32 1MiB 513MiB set 1 esp on \
        mkpart primary linux-swap 513MiB $((513 + ${SWAP_SIZE%G} * 1024))MiB \
        mkpart primary ext4 $((513 + ${SWAP_SIZE%G} * 1024))MiB 100% || error_exit "Partitioning failed."
    BOOT_PARTITION="${DISK}p1"
    SWAP_PARTITION="${DISK}p2"
    ROOT_PARTITION="${DISK}p3"
else
    parted -s "$DISK" mklabel gpt \
        mkpart primary fat32 1MiB 513MiB set 1 esp on \
        mkpart primary ext4 513MiB 100% || error_exit "Partitioning failed."
    BOOT_PARTITION="${DISK}p1"
    ROOT_PARTITION="${DISK}p2"
fi

# Format partitions (skip /home)
mkfs.fat -F32 "$BOOT_PARTITION" || error_exit "Formatting boot failed."
mkfs.ext4 "$ROOT_PARTITION" || error_exit "Formatting root failed."
if [ "$SWAP_SIZE" != "none" ]; then
    mkswap "$SWAP_PARTITION" || error_exit "Formatting swap failed."
    swapon "$SWAP_PARTITION"
fi
# Assume /home is already ext4 and mounted later; no mkfs here!

# Mount partitions
mount "$ROOT_PARTITION" /mnt || error_exit "Mounting root failed."
mkdir -p /mnt/boot && mount "$BOOT_PARTITION" /mnt/boot || error_exit "Mounting boot failed."
mkdir -p /mnt/home && mount "$HOME_PARTITION" /mnt/home || error_exit "Mounting home failed."

# Install base system
pacstrap /mnt base linux linux-firmware || error_exit "Pacstrap failed."

# Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab || error_exit "Genfstab failed."

# Chroot and configure
arch-chroot /mnt /bin/bash <<EOF || error_exit "Chroot failed."

# Set timezone
ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
hwclock --systohc

# Locale
echo "$LOCALE UTF-8" > /etc/locale.gen
locale-gen
echo "LANG=$LOCALE" > /etc/locale.conf

# Hostname
echo "$HOSTNAME" > /etc/hostname
cat <<HOSTS > /etc/hosts
127.0.0.1   localhost
::1         localhost
127.0.1.1   $HOSTNAME.localdomain $HOSTNAME
HOSTS

# Set root password
echo "root:$ROOT_PASSWORD" | chpasswd

# Install bootloader (systemd-boot for UEFI)
bootctl --path=/boot install

# Create bootloader config
cat <<BOOT > /boot/loader/entries/arch.conf
title   Arch Linux
linux   /vmlinuz-linux
initrd  /initramfs-linux.img
options root=PARTUUID=$(blkid -s PARTUUID -o value $ROOT_PARTITION) rw
BOOT
echo "default arch.conf" > /boot/loader/loader.conf

# Add user
useradd -m -G wheel "$USERNAME"
echo "$USERNAME:$USER_PASSWORD" | chpasswd
echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers  # Temporary sudo without pass; remove later if desired

# Install additional packages for Hyprland (Wayland compositor)
pacman -Syu --noconfirm hyprland xdg-desktop-portal-hyprland wayland mesa vulkan-intel nvidia amdvlk  # Adjust GPU drivers: intel/nvidia/amd
pacman -Syu --noconfirm kitty alacritty  # Terminals (optional)
pacman -Syu --noconfirm waybar wofi  # Bar and launcher (common for Hyprland)

# Enable services (if needed, e.g., for display manager; but Hyprland is manual start)
# For auto-login or SDDM, install sddm and enable: systemctl enable sddm

# Exit chroot
exit
EOF

# Function to copy Hyprland configs (customize this!)
copy_configs() {
    # Assumes configs are on a mounted USB at /mnt/usb/hyprland-configs
    # Or git clone: git clone your-repo /mnt/home/$USERNAME/.config/hypr
    # Example: mkdir -p /mnt/home/$USERNAME/.config/hypr
    # cp -r /path/to/your/configs/* /mnt/home/$USERNAME/.config/hypr/
    # chown -R $USERNAME:$USERNAME /mnt/home/$USERNAME/.config
    echo "Configs not copied. Manually add your config copy logic here."
}

copy_configs

# Unmount and reboot
umount -R /mnt
reboot

echo "Installation complete. Reboot and login as $USERNAME. Start Hyprland with 'Hyprland' in tty."
echo "Customize configs in ~/.config/hypr/hyprland.conf. Secure sudoers after setup."
